#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import os
from pathlib import Path

from wildfires.utils import handle_array_job_args

try:
    # This will only work after the path modification carried out in the job script.
    from specific import (
        CACHE_DIR,
        SimpleCache,
        get_model,
        data_split_cache,
        get_shap_values,
    )
except ImportError:
    """Not running as an HPC job yet."""


def func():
    # Used to re-compute specific failed jobs, `None` otherwise.
    indices = [
        0,
        1,
        2,
        3,
        4,
        7,
        8,
        9,
        15,
        61,
        62,
        63,
        64,
        65,
        66,
        68,
        69,
        73,
        75,
        76,
        77,
        78,
        79,
        80,
        81,
        82,
        83,
        92,
        93,
        102,
        103,
        119,
        120,
        121,
        122,
        123,
        128,
        129,
        130,
        132,
        169,
        170,
        171,
        172,
        174,
        175,
        176,
        177,
        178,
        179,
        180,
        181,
        182,
        183,
        184,
        185,
        188,
        189,
        200,
        201,
        208,
        209,
        229,
        230,
        231,
        232,
        233,
        235,
        236,
        237,
        242,
        260,
        261,
        275,
        276,
        277,
        278,
        280,
        281,
        283,
        284,
        285,
        286,
        287,
        288,
        289,
        290,
        291,
        292,
        302,
        303,
        333,
        334,
        335,
        336,
        337,
        345,
        346,
        347,
        349,
        366,
        367,
        382,
        383,
        384,
        385,
        390,
        391,
        397,
        401,
        402,
        403,
        404,
        405,
        406,
        407,
        408,
        409,
        419,
        420,
        446,
        447,
        448,
        449,
        450,
        456,
        457,
        458,
        465,
        479,
        480,
        488,
        489,
        490,
        491,
        492,
        493,
        499,
        500,
        501,
        502,
        503,
        505,
        506,
        507,
        508,
        509,
        520,
        521,
        532,
        533,
        548,
        549,
        550,
        551,
        552,
        553,
        554,
        555,
        556,
        561,
        562,
        563,
        564,
        579,
        580,
        595,
        596,
        601,
        602,
        603,
        604,
        606,
        608,
        620,
        621,
        646,
        647,
        648,
        649,
        651,
        652,
        653,
        654,
        655,
        664,
        665,
        666,
        667,
        680,
        681,
        698,
        699,
        704,
        705,
        706,
        707,
        708,
        709,
        717,
        718,
        735,
        736,
        737,
        738,
        739,
        740,
        741,
        742,
        743,
        751,
        752,
        753,
        754,
        768,
        769,
        801,
        802,
        808,
        809,
        810,
        811,
        814,
        815,
        823,
        824,
        856,
        857,
        858,
        859,
        860,
        861,
        862,
        863,
        864,
        868,
        869,
        870,
        871,
        892,
        893,
        936,
        937,
        946,
        947,
        948,
        949,
        950,
        951,
        966,
        967,
        977,
        978,
        1001,
        1002,
        1003,
        1004,
        1005,
        1006,
        1008,
        1009,
        1010,
        1013,
        1014,
        1015,
        1016,
        1049,
        1050,
        1054,
        1055,
        1056,
        1057,
        1058,
        1059,
        1064,
        1065,
        1073,
        1074,
        1086,
        1087,
        1088,
        1089,
        1090,
        1091,
        1094,
        1095,
        1096,
        1100,
        1101,
        1102,
        1104,
        1126,
        1128,
        1129,
        1130,
        1131,
        1132,
        1133,
        1139,
        1140,
        1147,
        1148,
        1163,
        1164,
        1165,
        1166,
        1167,
        1168,
        1170,
        1171,
        1172,
        1173,
        1174,
        1201,
        1202,
        1203,
        1204,
        1205,
        1206,
        1207,
        1217,
        1218,
        1230,
        1231,
        1241,
        1242,
        1243,
        1244,
        1245,
        1246,
        1247,
        1248,
        1249,
        1250,
        1251,
        1252,
        1267,
        1268,
        1275,
        1276,
        1277,
        1281,
        1282,
        1283,
        1284,
        1286,
        1287,
        1294,
        1295,
        1306,
        1307,
        1308,
        1309,
        1310,
        1311,
        1312,
        1313,
        1314,
        1324,
        1325,
        1332,
        1333,
        1334,
        1335,
        1336,
        1337,
        1338,
        1339,
        1340,
        1345,
        1346,
        1360,
        1361,
        1362,
        1363,
        1366,
        1367,
        1368,
        1369,
        1370,
        1380,
        1381,
        1393,
        1394,
        1395,
        1398,
        1403,
        1404,
        1405,
        1406,
        1407,
        1408,
        1411,
        1412,
        1426,
        1427,
        1428,
        1429,
        1430,
        1438,
        1439,
        1449,
        1450,
        1451,
        1452,
        1454,
        1455,
        1456,
        1457,
        1458,
        1459,
        1462,
        1463,
        1471,
        1472,
        1473,
        1474,
        1475,
        1485,
        1486,
        1494,
        1496,
        1497,
        1498,
        1503,
        1504,
        1505,
        1506,
        1507,
        1508,
        1514,
        1515,
        1521,
        1522,
        1529,
        1530,
        1531,
        1536,
        1537,
        1538,
        1540,
        1541,
        1562,
        1564,
        1565,
        1566,
        1572,
        1574,
        1575,
        1576,
        1577,
        1578,
        1579,
        1584,
        1585,
        1591,
        1592,
        1604,
        1605,
        1606,
        1616,
        1617,
        1618,
        1619,
        1620,
        1643,
        1644,
        1645,
        1646,
        1658,
        1659,
        1660,
        1661,
        1662,
        1663,
        1664,
        1672,
        1673,
        1677,
        1678,
        1689,
        1690,
        1691,
        1706,
        1707,
        1708,
        1709,
        1710,
        1737,
        1740,
        1741,
        1742,
        1750,
        1751,
        1752,
        1753,
        1754,
        1755,
        1756,
        1764,
        1765,
        1769,
        1770,
        1776,
        1781,
        1782,
        1791,
        1792,
        1793,
        1794,
        1795,
        1826,
        1827,
        1828,
        1829,
        1836,
        1837,
        1838,
        1839,
        1840,
        1843,
        1844,
        1851,
        1852,
        1855,
        1856,
        1862,
        1863,
        1864,
        1876,
        1877,
        1878,
        1879,
        1880,
        1901,
        1903,
        1904,
        1905,
        1914,
        1915,
        1916,
        1917,
        1918,
        1919,
        1920,
        1927,
        1928,
        1939,
        1940,
        1957,
        1958,
        1959,
        1962,
        1964,
        1965,
        1966,
        1971,
        1972,
        1973,
        1974,
        1975,
        1976,
        1977,
        1981,
        1982,
        2004,
        2005,
        2027,
        2028,
        2051,
        2053,
        2054,
        2056,
        2059,
        2060,
        2061,
        2073,
        2074,
        2075,
        2076,
        2077,
        2078,
        2079,
        2095,
        2096,
        2102,
        2103,
        2131,
        2132,
        2133,
        2134,
        2185,
        2187,
        2188,
        2189,
        2192,
        2193,
        2194,
        2201,
        2202,
        2203,
        2204,
        2205,
        2206,
        2207,
        2222,
        2225,
        2226,
        2235,
        2236,
        2255,
        2256,
        2257,
        2258,
        2313,
        2316,
        2317,
        2320,
        2323,
        2324,
        2326,
        2336,
        2337,
        2338,
        2339,
        2340,
        2341,
        2342,
        2345,
        2350,
        2351,
        2364,
        2365,
        2387,
        2388,
        2389,
        2390,
        2433,
        2435,
        2436,
        2437,
        2439,
        2440,
        2443,
        2449,
        2450,
        2451,
        2452,
        2453,
        2454,
        2455,
        2461,
        2465,
        2466,
        2470,
        2471,
        2487,
        2488,
        2489,
        2490,
        2533,
        2536,
        2537,
        2538,
        2540,
        2541,
        2542,
        2546,
        2547,
        2548,
        2549,
        2550,
        2551,
        2552,
        2563,
        2566,
        2567,
        2572,
        2573,
        2588,
        2589,
        2590,
        2591,
        2640,
        2641,
        2642,
        2643,
        2644,
        2646,
        2647,
        2648,
        2657,
        2658,
        2659,
        2660,
        2661,
        2662,
        2663,
        2671,
        2674,
        2675,
        2681,
        2682,
        2704,
        2705,
        2706,
        2707,
        2750,
        2752,
        2753,
        2754,
        2755,
        2756,
        2757,
        2758,
        2762,
        2763,
        2764,
        2765,
        2766,
        2767,
        2768,
        2773,
        2778,
        2779,
        2791,
        2792,
        2817,
        2818,
        2819,
        2820,
        2842,
        2845,
        2846,
        2847,
        2848,
        2849,
        2850,
        2851,
        2854,
        2855,
        2856,
        2858,
        2859,
        2860,
        2863,
        2869,
        2870,
        2882,
        2883,
        2895,
        2896,
        2897,
        2898,
        2899,
        2903,
        2920,
        2924,
        2925,
        2926,
        2927,
        2928,
        2929,
        2930,
        2933,
        2934,
        2935,
        2936,
        2937,
        2940,
        2944,
        2945,
        2948,
        2949,
        2959,
        2960,
        2973,
        2974,
        2975,
        2976,
        2977,
        2980,
        3013,
        3016,
        3017,
        3018,
        3019,
        3020,
        3021,
        3022,
        3024,
        3027,
        3028,
        3029,
        3032,
        3034,
        3038,
        3046,
        3047,
        3052,
        3053,
        3057,
        3058,
        3074,
        3075,
        3076,
        3077,
        3078,
        3089,
        3123,
        3125,
        3126,
        3127,
        3128,
        3129,
        3130,
        3131,
        3132,
        3138,
        3139,
        3140,
        3141,
        3142,
        3144,
        3145,
        3146,
        3150,
        3151,
        3159,
        3160,
        3179,
        3180,
        3181,
        3182,
        3183,
        3190,
        3230,
        3232,
        3233,
        3234,
        3235,
        3236,
        3237,
        3238,
        3239,
        3240,
        3245,
        3246,
        3247,
        3248,
        3249,
        3250,
        3254,
        3255,
        3258,
        3259,
        3266,
        3267,
        3300,
        3301,
        3302,
        3303,
        3304,
        3305,
        3309,
        3331,
        3332,
        3333,
        3334,
        3335,
        3337,
        3338,
        3340,
        3341,
        3343,
        3345,
        3346,
        3347,
        3348,
        3349,
        3350,
        3357,
        3358,
        3361,
        3362,
        3370,
        3371,
        3400,
        3401,
        3402,
        3403,
        3404,
        3405,
        3415,
        3456,
        3458,
        3459,
        3460,
        3461,
        3463,
        3464,
        3466,
        3467,
        3468,
        3472,
        3473,
        3474,
        3475,
        3476,
        3477,
        3479,
        3480,
        3482,
        3483,
        3488,
        3489,
        3506,
        3508,
        3509,
        3510,
        3511,
        3512,
        3513,
        3524,
        3556,
        3557,
        3558,
        3559,
        3560,
        3563,
        3564,
        3565,
        3566,
        3567,
        3571,
        3572,
        3573,
        3575,
        3576,
        3578,
        3588,
        3589,
        3592,
        3593,
        3599,
        3600,
        3622,
        3624,
        3625,
        3626,
        3627,
        3628,
        3629,
        3646,
        3676,
        3677,
        3678,
        3679,
        3680,
        3681,
        3682,
        3683,
        3685,
        3686,
        3687,
        3692,
        3693,
        3694,
        3695,
        3696,
        3698,
        3701,
        3708,
        3709,
        3714,
        3715,
        3718,
        3719,
        3740,
        3741,
        3743,
        3745,
        3746,
        3747,
        3748,
        3749,
        3759,
        3791,
        3792,
        3793,
        3794,
        3795,
        3796,
        3798,
        3799,
        3800,
        3801,
        3802,
        3811,
        3812,
        3813,
        3814,
        3815,
        3816,
        3818,
        3826,
        3827,
        3829,
        3830,
        3839,
        3840,
        3856,
        3857,
        3858,
        3859,
        3860,
        3861,
        3872,
        3904,
        3905,
        3907,
        3908,
        3909,
        3910,
        3911,
        3912,
        3913,
        3914,
        3915,
        3916,
        3922,
        3923,
        3924,
        3925,
        3926,
        3927,
        3929,
        3933,
        3934,
        3935,
        3940,
        3941,
        3946,
        3947,
        3969,
        3970,
        3971,
        3972,
        3973,
        3974,
        3975,
        3985,
        4017,
        4020,
        4021,
        4022,
        4023,
        4024,
        4025,
        4026,
        4027,
        4028,
        4029,
        4034,
        4035,
        4036,
        4037,
        4038,
        4039,
        4042,
        4050,
        4051,
        4052,
        4053,
        4054,
        4058,
        4059,
        4069,
        4071,
        4072,
        4073,
        4074,
        4075,
        4076,
        4082,
        4100,
        4102,
        4103,
        4104,
        4105,
        4106,
        4108,
        4109,
        4112,
        4113,
        4114,
        4115,
        4116,
        4117,
        4118,
        4119,
        4120,
        4121,
        4122,
        4127,
        4128,
        4129,
        4130,
        4131,
        4144,
        4145,
        4158,
        4160,
        4161,
        4162,
        4163,
        4164,
        4165,
        4166,
        4172,
        4175,
        4177,
        4178,
        4201,
        4202,
        4203,
        4204,
        4205,
        4206,
        4207,
        4208,
        4210,
        4211,
        4212,
        4213,
        4214,
        4223,
        4224,
        4225,
        4226,
        4227,
        4228,
        4229,
        4234,
        4235,
        4236,
        4237,
        4238,
        4248,
        4261,
        4263,
        4264,
        4265,
        4266,
        4267,
        4268,
        4269,
        4270,
        4285,
        4288,
        4292,
        4298,
        4299,
        4318,
        4322,
        4323,
        4324,
        4325,
        4326,
        4329,
        4330,
        4333,
        4334,
        4336,
        4338,
        4339,
        4340,
        4341,
        4342,
        4345,
        4350,
        4351,
        4352,
        4353,
        4354,
        4366,
        4367,
        4380,
        4382,
        4387,
        4388,
        4389,
        4390,
        4391,
        4392,
        4393,
        4399,
        4403,
        4411,
        4415,
        4416,
        4426,
        4427,
        4444,
        4445,
        4446,
        4447,
        4448,
        4449,
        4450,
        4451,
        4452,
        4453,
        4457,
        4458,
        4459,
        4460,
        4462,
        4464,
        4466,
        4467,
        4475,
        4476,
        4477,
        4478,
        4479,
        4498,
        4499,
        4507,
        4509,
        4510,
        4511,
        4512,
        4513,
        4514,
        4515,
        4524,
        4525,
        4526,
        4533,
        4539,
        4540,
        4549,
        4550,
        4563,
        4566,
        4568,
        4569,
        4570,
        4571,
        4573,
        4574,
        4575,
        4576,
        4578,
        4582,
        4583,
        4584,
        4585,
        4586,
        4587,
        4588,
        4596,
        4597,
        4598,
        4599,
        4600,
        4601,
        4609,
        4610,
        4624,
        4626,
        4627,
        4628,
        4629,
        4630,
        4631,
        4632,
        4638,
        4646,
        4652,
        4653,
        4659,
        4660,
        4669,
        4672,
        4673,
        4674,
        4675,
        4677,
        4678,
        4681,
        4682,
        4683,
        4687,
        4688,
        4689,
        4690,
        4691,
        4692,
        4693,
        4702,
        4703,
        4704,
        4705,
        4706,
        4707,
        4708,
        4723,
        4724,
        4737,
        4739,
        4740,
        4741,
        4742,
        4743,
        4744,
        4745,
        4746,
        4759,
        4768,
        4772,
        4773,
        4779,
        4795,
        4801,
        4802,
        4803,
        4804,
        4806,
        4807,
        4809,
        4810,
        4812,
        4820,
        4821,
        4822,
        4823,
        4825,
        4826,
        4828,
        4829,
        4838,
        4839,
        4840,
        4841,
        4842,
        4843,
        4844,
        4845,
        4858,
        4859,
        4890,
        4891,
        4892,
        4894,
        4895,
        4896,
        4897,
        4898,
        4899,
        4900,
        4911,
        4912,
        4913,
        4915,
        4921,
        4924,
        4925,
        4935,
        4936,
        4957,
        4959,
        4960,
        4961,
        4962,
        4964,
        4965,
        4966,
        4967,
        4969,
        4970,
        4973,
        4977,
        4978,
        4979,
        4980,
        4981,
        4982,
        4990,
        4991,
        4992,
        4993,
        4994,
        4996,
        4997,
        4998,
        5025,
        5028,
        5031,
        5032,
        5033,
        5034,
        5035,
        5036,
        5037,
        5045,
        5046,
        5047,
        5049,
        5054,
        5055,
        5059,
        5060,
        5071,
        5072,
        5105,
        5107,
        5108,
        5109,
        5110,
        5116,
        5118,
        5119,
        5120,
        5122,
        5123,
        5124,
        5126,
        5127,
        5128,
        5137,
        5138,
        5139,
        5140,
        5141,
        5142,
        5143,
        5144,
        5174,
        5176,
        5178,
        5179,
        5180,
        5181,
        5182,
        5183,
        5184,
        5188,
        5189,
        5195,
        5200,
        5201,
        5202,
        5205,
        5206,
        5207,
        5208,
        5213,
        5214,
        5232,
        5233,
        5234,
        5235,
        5236,
        5237,
        5238,
        5239,
        5240,
        5241,
        5242,
        5245,
        5248,
        5249,
        5250,
        5253,
        5254,
        5256,
        5260,
        5261,
        5262,
        5263,
        5264,
        5266,
        5267,
        5268,
        5289,
        5290,
        5292,
        5293,
        5294,
        5295,
        5296,
        5297,
        5298,
        5299,
        5300,
        5306,
        5308,
        5309,
        5310,
        5319,
        5320,
        5327,
        5328,
        5339,
        5340,
        5352,
        5353,
        5354,
        5355,
        5356,
        5357,
        5358,
        5359,
        5361,
        5366,
        5367,
        5368,
        5369,
        5370,
        5371,
        5376,
        5380,
        5381,
        5382,
        5383,
        5384,
        5385,
        5386,
        5387,
        5418,
        5419,
        5421,
        5422,
        5423,
        5424,
        5425,
        5426,
        5427,
        5430,
        5431,
        5438,
        5439,
        5440,
        5441,
        5448,
        5449,
        5454,
        5455,
        5460,
        5461,
        5482,
        5483,
        5484,
        5485,
        5486,
        5488,
        5489,
        5490,
        5491,
        5499,
        5500,
        5501,
        5502,
        5503,
        5504,
        5511,
        5515,
        5516,
        5517,
        5518,
        5519,
        5520,
        5521,
        5522,
        5538,
        5556,
        5557,
        5559,
        5560,
        5561,
        5562,
        5563,
        5564,
        5565,
        5570,
        5571,
        5577,
        5579,
        5580,
        5582,
        5587,
        5588,
        5592,
        5593,
        5601,
        5627,
        5628,
        5629,
        5630,
        5631,
        5633,
        5634,
        5635,
        5636,
        5639,
        5640,
        5641,
        5643,
        5644,
        5645,
        5652,
        5653,
        5654,
        5655,
        5656,
        5657,
        5658,
        5659,
        5660,
        5672,
        5696,
        5697,
        5698,
        5700,
        5701,
        5702,
        5703,
        5704,
        5705,
        5706,
        5710,
        5711,
        5715,
        5716,
        5717,
        5719,
        5723,
        5724,
        5727,
        5728,
        5738,
        5764,
        5765,
        5766,
        5767,
        5769,
        5770,
        5771,
        5772,
        5782,
        5783,
        5784,
        5786,
        5787,
        5788,
        5794,
        5798,
        5799,
        5800,
        5801,
        5802,
        5803,
        5804,
        5805,
        5815,
        5816,
        5837,
        5838,
        5839,
        5840,
        5842,
        5843,
        5844,
        5845,
        5846,
        5847,
        5848,
        5850,
        5851,
        5855,
        5857,
        5858,
        5860,
        5871,
        5872,
        5874,
        5875,
        5899,
        5900,
        5901,
        5902,
        5905,
        5906,
        5907,
        5908,
        5913,
        5914,
        5915,
        5916,
        5917,
        5918,
        5920,
        5926,
        5927,
        5928,
        5929,
        5930,
        5931,
        5932,
        5933,
        5940,
        5941,
        5963,
        5964,
        5965,
        5966,
        5967,
        5968,
        5969,
        5970,
        5972,
        5973,
        5974,
        5975,
        5976,
        5978,
        5979,
        5982,
        5983,
        5990,
        5994,
        5995,
        5997,
    ]

    index = int(os.environ["PBS_ARRAY_INDEX"])

    if indices is not None:
        index = indices[index]

    print("Index:", index)

    X_train, X_test, y_train, y_test = data_split_cache.load()
    rf = get_model()

    job_samples = 50

    tree_path_dependent_shap_interact_cache = SimpleCache(
        f"tree_path_dependent_shap_interact_{index}_{job_samples}",
        cache_dir=os.path.join(CACHE_DIR, "shap_interaction"),
    )

    @tree_path_dependent_shap_interact_cache
    def cached_get_interact_shap_values(model, X):
        return get_shap_values(model, X, interaction=True)

    cached_get_interact_shap_values(
        rf, X_train[index * job_samples : (index + 1) * job_samples]
    )


if __name__ == "__main__":
    handle_array_job_args(
        Path(__file__).resolve(),
        func,
        ncpus=1,
        mem="7gb",
        walltime="11:00:00",
        max_index=1734,
    )
